<!-- 声明文档类型为HTML5 -->
<!DOCTYPE html>

<!-- 开始HTML文档 -->
<html lang="en">
<!-- 头部区域开始，包含页面的元数据 -->
<head>
<link href="{{ url_for('static', filename='style.css') }}" rel="stylesheet"/>
<link rel="icon" href="{{ url_for('static', filename='favicon.ico') }}" type="image/x-icon">
<!-- 声明字符编码为UTF-8 -->
<meta charset="utf-8"/>
<!-- 设置页面的视口属性 -->
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<!-- 页面标题 -->
<title>云计算器 WebCalculator</title>
<!-- 设置浏览器兼容性 -->
<meta content="IE=edge" http-equiv="X-UA-Compatible">
<!-- 导入外部CSS样式表 -->
</head>
<!-- 主体区域开始，包含页面的内容 -->
<body>
<div class="container">
<!-- 页面主标题 -->
<h1><span class="special-character">☁</span>云计算器</h1>
<!-- 计算器输入表单 -->
<div class="input-container" id="input">
<form id="calculatorForm">
<!-- 用户输入的数学表达式 -->
<input name="expression" placeholder="输入数学表达式 按下回车开始计算" type="text"/>
<!-- 提交按钮 -->
<!-- <input type="submit" value="计算"/> -->
</form>
</div>
</div>
<!-- 主容器，包含计算器的所有内容 -->
<div class="container" id="main"></div>
<script>
    function addCard(data) {
    var expression = document.querySelector('input[name="expression"]').value;
    var data_json = JSON.parse(data); // 解析 JSON 字符串

    // 创建新的card-container
    const newCardContainer = document.createElement('div');
    newCardContainer.className = 'card-container';

    // 创建新的card元素和其子元素
    const newCard = document.createElement('div');
    newCard.className = 'card';
    
    const faceExpression = document.createElement('p');
    faceExpression.innerText = "表达式: " + expression;
    
    const faceResult = document.createElement('p');
    faceResult.innerText = "结果: " + data_json.result;
    
    var button = document.createElement("button");
    button.innerHTML = "折叠";
    button.addEventListener("click", function() {
    // Toggle visibility of the log content
    var logContentSpan = this.parentNode.querySelector('.log-content');
    if (logContentSpan.style.display === 'none' || !logContentSpan.style.display) {
        logContentSpan.style.display = 'inline';
    } else {
        logContentSpan.style.display = 'none';
    }
});
    
    const backLogLabel = document.createElement('span');
    backLogLabel.innerText = '日志:';
    
    const backLogContent = document.createElement('span');
    backLogContent.className = 'log-content';
    backLogContent.style.display = 'inline';  // 设置初始显示值
    backLogContent.innerText = "\n" + data_json.log;
    
    const backLog = document.createElement('p');
    backLog.appendChild(backLogLabel);
    backLog.appendChild(button);
    backLog.appendChild(backLogContent);
    
    newCard.appendChild(faceExpression);
    newCard.appendChild(faceResult);
    newCard.appendChild(backLog);
    
    newCardContainer.appendChild(newCard); // 添加card到card-container

    const container = document.querySelector('.container#main');
    container.insertBefore(newCardContainer, container.firstChild); // 添加newCardContainer到container所有元素的前面

}
</script>
<script>
        // 当表单被提交时执行以下函数
        document.getElementById('calculatorForm').addEventListener('submit', function(e) {
            // 阻止表单的默认提交行为
            e.preventDefault();

            // 获取用户输入的表达式
            let expression = e.target.elements.expression.value;

            // 使用 Fetch API 异步发送 POST 请求到服务器
            fetch('/calculate', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: 'expression=' + encodeURIComponent(expression)
            })
            .then(response => response.json())  // 解析服务器返回的JSON数据
            .then(data => {
                // 如果成功，使用addCard函数显示结果
                if (data.success) {
                    addCard(data.result);
                } else {
                    alert('计算错误: ' + data.error);
                }
            });
        });
    </script>
</body>
</html>
